{% extends 'base.html' %}

{% block title %}Your Preferences | News Advance{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-cog me-2"></i>News Preferences</h4>
                </div>
                <div class="card-body">
                    <div>
                        {% csrf_token %}

                        <div class="row mb-4">
                            <div class="col-md-12">
                                <h5><i class="fas fa-filter me-2 text-primary"></i>Content Filters</h5>
                                <hr>

                                <div class="mb-3">
                                    <label class="form-label">Political Balance</label>
                                    <select name="political_filter" class="form-select">
                                        <option value="all" {% if preferences.political_filter == 'all' %}selected{% endif %}>Show All Content</option>
                                        <option value="balanced" {% if preferences.political_filter == 'balanced' %}selected{% endif %}>Balanced Mix</option>
                                        <option value="neutral_only" {% if preferences.political_filter == 'neutral_only' %}selected{% endif %}>Neutral Sources Only</option>
                                        <option value="diverse" {% if preferences.political_filter == 'diverse' %}selected{% endif %}>Diverse Viewpoints</option>
                                    </select>
                                    <div class="form-text">Choose how you want to balance news across the political spectrum in your feed</div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-12">
                                <h5><i class="fas fa-chart-pie me-2 text-primary"></i>Analysis Features</h5>
                                <hr>

                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="enable_fact_check" name="enable_fact_check" {% if preferences.enable_fact_check %}checked{% endif %}>
                                    <label class="form-check-label" for="enable_fact_check">Enable Fact-Checking</label>
                                    <div class="form-text">Show fact-check results for claims in articles</div>
                                </div>

                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="enable_bias_analysis" name="enable_bias_analysis" {% if preferences.enable_bias_analysis %}checked{% endif %}>
                                    <label class="form-check-label" for="enable_bias_analysis">Enable Bias Analysis</label>
                                    <div class="form-text">This will remove the related section from the article view</div>
                                </div>

                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="enable_sentiment_analysis" name="enable_sentiment_analysis" {% if preferences.enable_sentiment_analysis %}checked{% endif %}>
                                    <label class="form-check-label" for="enable_sentiment_analysis">Enable Sentiment Analysis</label>
                                    <div class="form-text">This will remove the related section from the article view</div>
                                </div>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="enable_logical_fallacy_analysis" name="enable_logical_fallacy_analysis" {% if preferences.enable_logical_fallacy_analysis %}checked{% endif %}>
                                    <label class="form-check-label" for="enable_logical_fallacy_analysis">Enable Logical Fallacy Detection</label>
                                    <div class="form-text">Show detected logical fallacies and examples in the AI Analysis panel</div>
                                </div>

                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-12">
                                <h5><i class="fas fa-bell me-2 text-primary"></i>Email Notifications</h5>
                                <hr>

                                <div class="form-check form-switch mb-3">
                                    {% if user.email %}
                                        <input class="form-check-input" type="checkbox" id="receive_misinformation_alerts" name="receive_misinformation_alerts" {% if preferences.receive_misinformation_alerts %}checked{% endif %}>
                                        <label class="form-check-label" for="receive_misinformation_alerts">Misinformation Alerts</label>
                                        <div class="form-text">Receive email alerts about trending misinformation and fact-check updates</div>
                                    {% else %}
                                        <input class="form-check-input" type="checkbox" id="receive_misinformation_alerts" name="receive_misinformation_alerts" disabled>
                                        <label class="form-check-label text-muted" for="receive_misinformation_alerts">Misinformation Alerts</label>
                                        <div class="form-text text-warning">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            Email address required. <a href="{% url 'accounts:edit_profile' %}" class="text-decoration-none">Add email address</a> to enable notifications.
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="daily_digest_email" name="daily_digest_email" disabled>
                                    <label class="form-check-label" for="daily_digest_email">Daily News Digest (coming soon)</label>
                                    <div class="form-text">This feature is coming soon - you'll receive a daily email with personalized news</div>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <div id="save-status" class="alert alert-success d-none" role="alert">
                                <i class="fas fa-check-circle me-2"></i>Preferences saved automatically!
                            </div>
                            <a href="{% url 'accounts:profile' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Return to Profile
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    // Function to show save status
    function showSaveStatus(success, message) {
        const statusDiv = document.getElementById('save-status');
        statusDiv.className = success ? 'alert alert-success' : 'alert alert-danger';
        statusDiv.innerHTML = success ?
            '<i class="fas fa-check-circle me-2"></i>Preferences saved automatically!' :
            '<i class="fas fa-exclamation-triangle me-2"></i>Error saving preferences: ' + message;
        statusDiv.classList.remove('d-none');

        // Hide after 3 seconds
        setTimeout(() => {
            statusDiv.classList.add('d-none');
        }, 3000);
    }

    // Function to auto-save preference
    function autoSavePreference(fieldName, fieldValue) {
        fetch('{% url "accounts:auto_save_preferences" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({
                field: fieldName,
                value: fieldValue
            })
        })
        .then(response => response.json())
        .then(data => {
            showSaveStatus(data.success, data.error || data.message);
        })
        .catch(error => {
            console.error('Error:', error);
            showSaveStatus(false, 'Network error occurred');
        });
    }

    // Add event listeners to all form controls

    // Checkbox switches
    document.getElementById('enable_fact_check').addEventListener('change', function() {
        autoSavePreference('enable_fact_check', this.checked);
    });

    document.getElementById('enable_bias_analysis').addEventListener('change', function() {
        autoSavePreference('enable_bias_analysis', this.checked);
    });

    document.getElementById('enable_logical_fallacy_analysis').addEventListener('change', function() {
        autoSavePreference('enable_logical_fallacy_analysis', this.checked);
    });

    document.getElementById('enable_sentiment_analysis').addEventListener('change', function() {
        autoSavePreference('enable_sentiment_analysis', this.checked);
    });

    // Only add event listener for misinformation alerts if the checkbox is not disabled
    const misinformationAlertsCheckbox = document.getElementById('receive_misinformation_alerts');
    if (misinformationAlertsCheckbox && !misinformationAlertsCheckbox.disabled) {
        misinformationAlertsCheckbox.addEventListener('change', function() {
            autoSavePreference('receive_misinformation_alerts', this.checked);
        });
    }

    // Select dropdown
    document.querySelector('select[name="political_filter"]').addEventListener('change', function() {
        autoSavePreference('political_filter', this.value);
    });
});
</script>
{% endblock %}
