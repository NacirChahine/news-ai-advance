{% extends "base.html" %}
{% load static %}
{% load math_filters %}

{% block title %}{{ article.title }} - Analysis{% endblock %}

{% block content %}
<div class="container my-5">
    <!-- Article header with source info -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="mb-2">{{ article.title }}</h1>
            <div class="d-flex align-items-center mb-3">
                <span class="text-muted me-3">{{ article.published_date|date:"F j, Y" }}</span>
                <span class="me-3">|</span>
                <span class="me-3">By {{ article.author }}</span>
                <span class="me-3">|</span>
                <a href="{% url 'news_aggregator:source_detail' article.source.id %}" class="text-decoration-none">
                    <span class="badge bg-secondary">{{ article.source.name }}</span>
                </a>
            </div>
        </div>
        <div class="col-md-4 text-md-end">
            {% if user.is_authenticated %}
            <button class="btn {% if is_saved %}btn-success{% else %}btn-outline-primary{% endif %} save-article"
                    data-article-id="{{ article.id }}">
                <i class="bi {% if is_saved %}bi-bookmark-fill{% else %}bi-bookmark{% endif %}"></i>
                {% if is_saved %}Saved{% else %}Save Article{% endif %}
            </button>
            {% endif %}
            <a href="{{ article.url }}" target="_blank" class="btn btn-outline-secondary ms-2">
                <i class="bi bi-box-arrow-up-right"></i> View Original
            </a>
        </div>
    </div>

    <!-- Analysis overview card -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <h5 class="card-title">Analysis Overview</h5>

                    <div class="row g-4 mt-3">
                        <!-- Bias Analysis -->
                        <div class="col-md-4">
                            <div class="p-3 border rounded h-100">
                                <h6 class="mb-3">Political Bias</h6>
                                {% if bias_analysis %}
                                <div class="text-center mb-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <small>Left</small>
                                        <small>Center</small>
                                        <small>Right</small>
                                    </div>
                                    <div class="position-relative">
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar bg-primary" role="progressbar"
                                                 style="width: 100%;" aria-valuenow="100"
                                                 aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        {% with position=bias_analysis.bias_score|add:1|mul:50 %}
                                        <div class="position-absolute top-0" style="left: {{ position }}%; transform: translateX(-50%);"><i class="bi bi-caret-down-fill text-dark"></i></div>
                                        {% endwith %}
                                    </div>
                                </div>
                                <div class="text-center">
                                    <span class="badge
                                        {% if bias_analysis.political_leaning == 'left' %}bg-danger{% endif %}
                                        {% if bias_analysis.political_leaning == 'center-left' %}bg-warning text-dark{% endif %}
                                        {% if bias_analysis.political_leaning == 'center' %}bg-success{% endif %}
                                        {% if bias_analysis.political_leaning == 'center-right' %}bg-warning text-dark{% endif %}
                                        {% if bias_analysis.political_leaning == 'right' %}bg-danger{% endif %}">
                                        {{ bias_analysis.get_political_leaning_display }}
                                    </span>
                                    <p class="small text-muted mt-2">Confidence: {{ bias_analysis.confidence|floatformat:2 }}</p>
                                </div>
                                {% else %}
                                <div class="text-center text-muted">
                                    <p>No bias analysis available</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Sentiment Analysis -->
                        <div class="col-md-4">
                            <div class="p-3 border rounded h-100">
                                <h6 class="mb-3">Sentiment Analysis</h6>
                                {% if sentiment_analysis %}
                                <div class="d-flex justify-content-center mb-3">
                                    <div class="text-center">
                                        {% with sentiment=sentiment_analysis.sentiment_score %}
                                        {% if sentiment > 0.1 %}
                                        <i class="bi bi-emoji-smile fs-1 text-success"></i>
                                        <h5 class="mt-2">Positive</h5>
                                        {% elif sentiment < -0.1 %}
                                        <i class="bi bi-emoji-frown fs-1 text-danger"></i>
                                        <h5 class="mt-2">Negative</h5>
                                        {% else %}
                                        <i class="bi bi-emoji-neutral fs-1 text-secondary"></i>
                                        <h5 class="mt-2">Neutral</h5>
                                        {% endif %}
                                        {% endwith %}
                                    </div>
                                </div>

                                <div class="mt-3">
                                    <div class="d-flex justify-content-between small mb-1">
                                        <span>Positive</span>
                                        <span>{{ sentiment_analysis.positive_score|floatformat:2 }}</span>
                                    </div>
                                    <div class="progress mb-3" style="height: 6px;">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: {{ sentiment_analysis.positive_score|mul:100 }}%;" aria-valuenow="{{ sentiment_analysis.positive_score|mul:100 }}" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>

                                    <div class="d-flex justify-content-between small mb-1">
                                        <span>Negative</span>
                                        <span>{{ sentiment_analysis.negative_score|floatformat:2 }}</span>
                                    </div>
                                    <div class="progress mb-3" style="height: 6px;">
                                        <div class="progress-bar bg-danger" role="progressbar" style="width: {{ sentiment_analysis.negative_score|mul:100 }}%;" aria-valuenow="{{ sentiment_analysis.negative_score|mul:100 }}" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>

                                    <div class="d-flex justify-content-between small mb-1">
                                        <span>Neutral</span>
                                        <span>{{ sentiment_analysis.neutral_score|floatformat:2 }}</span>
                                    </div>
                                    <div class="progress mb-3" style="height: 6px;">
                                        <div class="progress-bar bg-secondary" role="progressbar" style="width: {{ sentiment_analysis.neutral_score|mul:100 }}%;" aria-valuenow="{{ sentiment_analysis.neutral_score|mul:100 }}" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                                {% else %}
                                <div class="text-center text-muted">
                                    <p>No sentiment analysis available</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Source Reliability -->
                        <div class="col-md-4">
                            <div class="p-3 border rounded h-100">
                                <h6 class="mb-3">Source Reliability</h6>
                                <div class="text-center mb-3">
                                    <div class="position-relative d-inline-block">
                                        <svg width="120" height="120" viewBox="0 0 120 120">
                                            <circle cx="60" cy="60" r="54" fill="none" stroke="#e6e6e6" stroke-width="12"/>
                                            <circle cx="60" cy="60" r="54" fill="none" stroke="url(#gradient)" stroke-width="12"
                                                    stroke-dasharray="339.3" stroke-dashoffset="{{ article.source.reliability_score|sub:100|mul:3.393 }}"
                                                    transform="rotate(-90 60 60)"/>
                                            <text x="60" y="65" text-anchor="middle" fill="#333" font-size="20" font-weight="bold">
                                                {{ article.source.reliability_score|floatformat:0 }}
                                            </text>
                                            <defs>
                                                <linearGradient id="gradient">
                                                    <stop offset="0%" stop-color="#ff4d4d" />
                                                    <stop offset="50%" stop-color="#ffcc00" />
                                                    <stop offset="100%" stop-color="#00cc44" />
                                                </linearGradient>
                                            </defs>
                                        </svg>
                                    </div>
                                </div>

                                <div class="text-center">
                                    {% with reliability=article.source.reliability_score %}
                                    {% if reliability >= 80 %}
                                    <span class="badge bg-success">Highly Reliable</span>
                                    {% elif reliability >= 60 %}
                                    <span class="badge bg-info text-dark">Reliable</span>
                                    {% elif reliability >= 40 %}
                                    <span class="badge bg-warning text-dark">Somewhat Reliable</span>
                                    {% else %}
                                    <span class="badge bg-danger">Less Reliable</span>
                                    {% endif %}

                                    <p class="small text-muted mt-2">
                                        Based on historical accuracy and
                                        <a href="{% url 'news_aggregator:source_detail' article.source.id %}" class="text-decoration-none">
                                            source profile
                                        </a>
                                    </p>
                                    {% endwith %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-5">
        <!-- Article content and summary -->
        <div class="col-lg-8">
            {% if article.image_url %}
            <div class="mb-4">
                <img src="{{ article.image_url }}" alt="{{ article.title }}" class="img-fluid rounded">
            </div>
            {% endif %}

            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h5 class="card-title">Summary</h5>
                    <p class="card-text">{{ article.summary }}</p>
                </div>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <h5 class="card-title">Full Article Content</h5>
                    <div class="article-content mt-3">
                        {% for paragraph in article.content.split|slice:"1:" %}
                        <p>{{ paragraph }}</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Fact checks and key points -->
        <div class="col-lg-4">
            <!-- Misinformation Alerts -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h5 class="card-title">Misinformation Alerts</h5>
                    {% if misinformation_alerts %}
                    <div class="mt-2">
                        {% for alert in misinformation_alerts %}
                        <div class="mb-3 pb-2 {% if not forloop.last %}border-bottom{% endif %}">
                            <div class="d-flex align-items-center mb-1">
                                {% if alert.severity == 'critical' %}
                                <span class="badge bg-danger me-2">Critical</span>
                                {% elif alert.severity == 'high' %}
                                <span class="badge bg-warning text-dark me-2">High</span>
                                {% elif alert.severity == 'medium' %}
                                <span class="badge bg-info text-dark me-2">Medium</span>
                                {% else %}
                                <span class="badge bg-success me-2">Low</span>
                                {% endif %}
                                <a href="{% url 'news_analysis:alert_detail' alert.id %}" class="text-decoration-none">{{ alert.title }}</a>
                            </div>
                            <p class="small text-muted mb-0">Detected: {{ alert.detected_at|date:"M j, Y" }}</p>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center text-muted my-4">
                        <p>No related misinformation alerts.</p>
                    </div>
                    {% endif %}
                </div>
            </div>


            <!-- Logical Fallacies Detected -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h5 class="card-title">Logical Fallacies</h5>
                    {% if article.fallacy_detections.all %}
                    <ul class="list-group list-group-flush mt-2">
                        {% for det in article.fallacy_detections.all %}
                        <li class="list-group-item">
                            <span class="badge bg-dark me-2">{{ det.fallacy.name }}</span>
                            {% if det.confidence %}
                            <span class="small text-muted">Confidence: {{ det.confidence|floatformat:2 }}</span>
                            {% endif %}
                            {% if det.evidence_excerpt %}
                            <p class="mb-0 mt-2 small">“{{ det.evidence_excerpt }}”</p>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <div class="text-center text-muted my-3">
                        <p>No logical fallacies detected.</p>
                    </div>
                    {% endif %}
                    <div class="mt-2">
                        <a href="{% url 'news_analysis:fallacies' %}" class="small text-decoration-none"><i class="fas fa-book me-1"></i>Learn about fallacies</a>
                    </div>
                </div>
            </div>

            <!-- Fact check results -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h5 class="card-title">Fact Check Results</h5>

                    {% if fact_checks %}
                    <div class="mt-3">
                        {% for fact in fact_checks %}
                        <div class="mb-3 pb-3 {% if not forloop.last %}border-bottom{% endif %}">
                            <h6 class="mb-2">Claim:</h6>
                            <p class="mb-2">{{ fact.claim }}</p>

                            <div class="d-flex align-items-center mb-2">
                                <h6 class="mb-0 me-2">Rating:</h6>
                                <span class="badge
                                    {% if fact.rating == 'true' %}bg-success{% endif %}
                                    {% if fact.rating == 'mostly_true' %}bg-info{% endif %}
                                    {% if fact.rating == 'half_true' %}bg-warning text-dark{% endif %}
                                    {% if fact.rating == 'mostly_false' %}bg-danger{% endif %}
                                    {% if fact.rating == 'false' %}bg-danger{% endif %}
                                    {% if fact.rating == 'pants_on_fire' %}bg-dark{% endif %}">
                                    {{ fact.get_rating_display }}
                                </span>
                            </div>

                            <h6 class="mb-2">Explanation:</h6>
                            <p class="mb-0">{{ fact.explanation }}</p>

                            {% if fact.sources %}
                            <a href="{{ fact.sources }}" target="_blank" class="small">View Sources</a>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center text-muted my-4">
                        <p>No fact checks available for this article</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Related articles -->
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <h5 class="card-title">Related Articles</h5>

                    {% if related_articles %}
                    <div class="mt-3">
                        {% for related in related_articles %}
                        <div class="mb-3 {% if not forloop.last %}pb-3 border-bottom{% endif %}">
                            <a href="{% url 'news_aggregator:article_detail' related.id %}" class="text-decoration-none">
                                <h6 class="mb-1">{{ related.title }}</h6>
                            </a>
                            <div class="d-flex align-items-center small text-muted">
                                <span>{{ related.source.name }}</span>
                                <span class="mx-2">•</span>
                                <span>{{ related.published_date|date:"M j, Y" }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center text-muted my-4">
                        <p>No related articles available</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Handle save article button
        $('.save-article').click(function() {
            var articleId = $(this).data('article-id');
            var button = $(this);

            $.ajax({
                url: "{% url 'news_aggregator:save_article' %}",
                type: "POST",
                data: {
                    'article_id': articleId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(data) {
                    if (data.saved) {
                        button.removeClass('btn-outline-primary').addClass('btn-success');
                        button.find('i').removeClass('bi-bookmark').addClass('bi-bookmark-fill');
                        button.text(' Saved');
                        button.prepend('<i class="bi bi-bookmark-fill"></i>');
                    } else {
                        button.removeClass('btn-success').addClass('btn-outline-primary');
                        button.find('i').removeClass('bi-bookmark-fill').addClass('bi-bookmark');
                        button.text(' Save Article');
                        button.prepend('<i class="bi bi-bookmark"></i>');
                    }
                }
            });
        });
    });
</script>
{% endblock %}
